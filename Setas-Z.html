<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicoNavarra</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1a1f16;
            --bg2: #242b1e;
            --card: #2d3527;
            --fg: #f4f1e8;
            --fg2: #c4bfa8;
            --muted: #8a8570;
            --accent: #d4a855;
            --accent2: #7fa05b;
            --border: #3d4535;
            --danger: #c75b5b;
            --success: #5b9c6b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--bg); color: var(--fg); min-height: 100vh; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        
        .tab-btn { padding: 0.5rem 0.75rem; font-weight: 600; color: var(--muted); border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--accent); border-color: var(--accent); }
        
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 0.5rem; }
        
        .btn { background: var(--accent); color: var(--bg); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; }
        .btn2 { background: var(--bg2); color: var(--fg2); border: 1px solid var(--border); padding: 0.4rem 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; }
        
        #map { height: 300px; border-radius: 0.5rem; border: 1px solid var(--border); }
        .leaflet-container { background: var(--bg2); }
        .leaflet-popup-content-wrapper { background: var(--card); color: var(--fg); border-radius: 0.375rem; z-index: 1000; }
        .leaflet-popup-tip { background: var(--card); }
        .leaflet-control-zoom { z-index: 500 !important; }
        
        .prob-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .prob-fill { height: 100%; border-radius: 3px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 2000; }
        .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: 0.5rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; z-index: 2001; }
        .modal-lg { max-width: 750px; }
        
        .skeleton { background: linear-gradient(90deg, var(--card) 25%, var(--bg2) 50%, var(--card) 75%); background-size: 200% 100%; animation: sk 1.5s infinite; }
        @keyframes sk { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .tag { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.75rem; cursor: pointer; }
        
        .danger-box { background: rgba(199,91,91,0.15); border: 1px solid var(--danger); border-radius: 0.5rem; padding: 0.75rem; }
        .similarity-box { background: rgba(127,160,91,0.15); border: 1px solid var(--accent2); border-radius: 0.5rem; padding: 0.75rem; }
        
        .mush-img { background: var(--bg2); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; min-height: 180px; }
        
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        
        .adj-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .adj-btn { padding: 0.4rem; border-radius: 0.375rem; border: 1px solid var(--border); background: var(--bg2); color: var(--muted); cursor: pointer; font-size: 0.7rem; text-align: center; transition: all 0.2s; }
        .adj-btn:hover { border-color: var(--accent); }
        .adj-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        
        .calc-table { font-size: 0.7rem; width: 100%; border-collapse: collapse; }
        .calc-table th, .calc-table td { padding: 0.25rem 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        .calc-table th { color: var(--muted); font-weight: 500; }
        .calc-table .value { color: var(--accent); font-weight: 600; }
        
        .collapse-header { cursor: pointer; user-select: none; }
        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapse-content.open { max-height: 500px; }
        
        .feature-list { list-style: none; }
        .feature-list li { position: relative; padding-left: 1.25rem; margin-bottom: 0.25rem; }
        .feature-list li::before { content: '‚Üí'; position: absolute; left: 0; color: var(--accent); }
        
        @media (min-width: 1024px) {
            .map-grid { display: grid; grid-template-columns: 1fr 280px; gap: 1rem; }
        }
        @media (max-width: 1023px) {
            .map-grid { display: block; }
            .map-side { margin-top: 1rem; }
        }
    </style>
</head>
<body>
    <header class="sticky top-0 z-50 border-b" style="background: var(--bg); border-color: var(--border);">
        <div class="max-w-6xl mx-auto px-3 py-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, var(--accent2), var(--accent));">
                    <svg class="w-5 h-5" fill="var(--bg)" viewBox="0 0 24 24"><path d="M12 2C9.5 2 7.5 4 7.5 6.5c0 1.5.7 2.8 1.8 3.7L8 12H6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2h-2l-1.3-1.8c1.1-.9 1.8-2.2 1.8-3.7C16.5 4 14.5 2 12 2z"/></svg>
                </div>
                <h1 class="text-lg font-bold">MicoNavarra</h1>
            </div>
            <div class="flex gap-2">
                <button id="langBtn" class="btn2">ES</button>
                <button id="historyBtn" class="btn2" title="Hist√≥rico">üìä</button>
                <button id="noteBtn" class="btn2" title="Cuaderno">üìù</button>
            </div>
        </div>
        <nav class="max-w-6xl mx-auto px-3 flex gap-1">
            <button class="tab-btn active" data-tab="map">Mapa</button>
            <button class="tab-btn" data-tab="report">Informe</button>
            <button class="tab-btn" data-tab="guide">Gu√≠a</button>
        </nav>
    </header>

    <main class="max-w-6xl mx-auto px-3 py-3">
        <!-- MAPA -->
        <section id="tab-map" class="block">
            <div class="map-grid">
                <div>
                    <h2 class="text-base font-semibold mb-1" style="color: var(--accent);">Predicci√≥n por Comarcas</h2>
                    <p class="text-xs mb-2" style="color: var(--muted);">Pulsa en una zona para ver detalles</p>
                    <div id="map"></div>
                    <div class="flex flex-wrap gap-2 mt-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#5b9c6b"></span>Alta</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#d4a855"></span>Media</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#c17f59"></span>Baja</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded" style="background:#c75b5b"></span>M√≠nima</span>
                    </div>
                </div>
                <div class="map-side space-y-3">
                    <div class="card p-3">
                        <h3 class="font-semibold text-sm mb-2" style="color: var(--accent);">Top Comarcas</h3>
                        <div id="topList" class="space-y-1 text-sm"><div class="skeleton h-5"></div></div>
                    </div>
                    <div class="card p-3">
                        <h3 class="font-semibold text-sm mb-2" style="color: var(--accent);">Mis Ubicaciones</h3>
                        <div id="savedList" class="text-xs" style="color: var(--muted);">Guarda ubicaciones</div>
                    </div>
                    <div class="card p-3">
                        <h3 class="font-semibold text-sm mb-2" style="color: var(--accent);">Buscar</h3>
                        <div class="flex gap-1">
                            <input id="searchIn" type="text" class="flex-1 rounded px-2 py-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="Buscar...">
                            <button id="searchBtn" class="btn text-sm px-2">üîç</button>
                        </div>
                        <div id="searchRes" class="mt-2 text-xs"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- INFORME -->
        <section id="tab-report" class="hidden">
            <div class="grid lg:grid-cols-3 gap-3">
                <div class="card p-3">
                    <h3 class="font-semibold text-sm mb-2" style="color: var(--accent);">Ubicaciones</h3>
                    <div id="reportList" class="text-xs" style="color: var(--muted);">Sin ubicaciones</div>
                </div>
                <div class="lg:col-span-2">
                    <div id="noLoc" class="card p-6 text-center">
                        <div class="text-3xl mb-2">üìç</div>
                        <p class="text-sm">Selecciona una ubicaci√≥n</p>
                    </div>
                    <div id="locInfo" class="card p-3 hidden">
                        <h2 id="locName" class="text-lg font-bold mb-1">-</h2>
                        <p id="locMeta" class="text-xs mb-2" style="color: var(--muted);">-</p>
                        
                        <!-- Ajustes colapsados -->
                        <div class="mb-3">
                            <div class="collapse-header flex items-center justify-between p-2 rounded" style="background:var(--bg2)" onclick="toggleCollapse('adjCollapse')">
                                <span class="text-xs font-semibold" style="color:var(--accent)">‚öôÔ∏è Ajustes de c√°lculo</span>
                                <span id="adjArrow" style="color:var(--muted)">‚ñº</span>
                            </div>
                            <div id="adjCollapse" class="collapse-content">
                                <div class="p-2" style="background:var(--bg2)">
                                    <div class="mb-2">
                                        <p class="text-xs mb-1" style="color:var(--muted)">Bosque objetivo:</p>
                                        <div class="flex flex-wrap gap-1" id="forestBtns"></div>
                                    </div>
                                    <div class="mb-2">
                                        <p class="text-xs mb-1" style="color:var(--muted)">Orientaci√≥n:</p>
                                        <div class="adj-grid" id="orientBtns">
                                            <button class="adj-btn" data-o="N">N</button>
                                            <button class="adj-btn" data-o="NE">NE</button>
                                            <button class="adj-btn" data-o="E">E</button>
                                            <button class="adj-btn" data-o="SE">SE</button>
                                            <button class="adj-btn" data-o="S">S</button>
                                            <button class="adj-btn" data-o="SO">SO</button>
                                            <button class="adj-btn" data-o="O">O</button>
                                            <button class="adj-btn" data-o="NO">NO</button>
                                            <button class="adj-btn active" data-o="">-</button>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <p class="text-xs mb-1" style="color:var(--muted)">Zona:</p>
                                        <div class="flex gap-1" id="zoneBtns">
                                            <button class="adj-btn flex-1" data-z="valle">Valle</button>
                                            <button class="adj-btn flex-1" data-z="ladera">Ladera</button>
                                            <button class="adj-btn flex-1 active" data-z="">-</button>
                                        </div>
                                    </div>
                                    <div class="mb-2">
                                        <p class="text-xs mb-1" style="color:var(--muted)">Altitud:</p>
                                        <div class="flex gap-1" id="altBtns">
                                            <button class="adj-btn flex-1" data-a="-200">-200m</button>
                                            <button class="adj-btn flex-1" data-a="-100">-100m</button>
                                            <button class="adj-btn flex-1 active" data-a="0">=</button>
                                            <button class="adj-btn flex-1" data-a="100">+100m</button>
                                            <button class="adj-btn flex-1" data-a="200">+200m</button>
                                        </div>
                                    </div>
                                    <button id="resetAdj" class="text-xs" style="color:var(--muted)">Resetear</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="wLoad" class="text-center py-4"><div class="skeleton h-12 w-full"></div></div>
                        <div id="wContent" class="hidden">
                            <div class="grid grid-cols-4 gap-1 mb-3 text-center text-xs">
                                <div class="p-1 rounded" style="background:var(--bg2)"><div id="wIcon" class="text-lg">-</div><div id="wTemp" class="font-bold">-</div><div style="color:var(--muted)">¬∞C</div></div>
                                <div class="p-1 rounded" style="background:var(--bg2)"><div class="text-lg">üíß</div><div id="wHum" class="font-bold">-</div><div style="color:var(--muted)">%</div></div>
                                <div class="p-1 rounded" style="background:var(--bg2)"><div class="text-lg">üåß</div><div id="wRain" class="font-bold">-</div><div style="color:var(--muted)">mm</div></div>
                                <div class="p-1 rounded" style="background:var(--bg2)"><div class="text-lg">üí®</div><div id="wWind" class="font-bold">-</div><div style="color:var(--muted)">km/h</div></div>
                            </div>
                            <h4 class="font-semibold text-xs mb-1">7 d√≠as</h4>
                            <div id="f7" class="grid grid-cols-7 gap-1 text-center text-xs mb-3"></div>
                            
                            <!-- C√°lculo colapsado -->
                            <div class="collapse-header flex items-center justify-between p-2 rounded mb-2" style="background:var(--bg2)" onclick="toggleCollapse('calcCollapse')">
                                <span class="text-xs" style="color:var(--muted)">üìä Ver detalle del c√°lculo</span>
                                <span id="calcArrow" style="color:var(--muted)">‚ñº</span>
                            </div>
                            <div id="calcCollapse" class="collapse-content">
                                <div class="p-2 rounded mb-3" style="background:var(--bg2)">
                                    <table class="calc-table" id="calcTable"></table>
                                </div>
                            </div>
                            
                            <h4 class="font-semibold text-xs mb-1">Especies</h4>
                            <div id="mushList" class="space-y-1 text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- GU√çA -->
        <section id="tab-guide" class="hidden">
            <input id="mushSearch" type="text" class="w-full rounded px-3 py-2 mb-2 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="Buscar seta...">
            
            <div class="mb-2">
                <p class="text-xs mb-1" style="color:var(--muted)">Temporada:</p>
                <div class="flex flex-wrap gap-1 mb-2">
                    <button class="tag season active" data-f="all" style="background:var(--accent);color:var(--bg)">Todas</button>
                    <button class="tag season" data-f="spring" style="background:var(--bg2)">Primavera</button>
                    <button class="tag season" data-f="summer" style="background:var(--bg2)">Verano</button>
                    <button class="tag season" data-f="autumn" style="background:var(--bg2)">Oto√±o</button>
                    <button class="tag season" data-f="winter" style="background:var(--bg2)">Invierno</button>
                </div>
            </div>
            
            <div class="mb-3">
                <p class="text-xs mb-1" style="color:var(--muted)">H√°bitat:</p>
                <div class="flex flex-wrap gap-1">
                    <button class="tag habitat" data-h="hayedo" style="background:var(--bg2)">Hayedo</button>
                    <button class="tag habitat" data-h="pinar" style="background:var(--bg2)">Pinar</button>
                    <button class="tag habitat" data-h="robledal" style="background:var(--bg2)">Robledal</button>
                    <button class="tag habitat" data-h="carrascal" style="background:var(--bg2)">Carrascal</button>
                    <button class="tag habitat" data-h="pastos" style="background:var(--bg2)">Pastos</button>
                </div>
            </div>
            
            <div id="mushGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-2"></div>
        </section>
    </main>

    <!-- MODALS -->
    <div id="safetyModal" class="modal">
        <div class="modal-content p-4">
            <div class="text-center">
                <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                <h2 class="text-lg font-bold mb-2" style="color:var(--danger)">Aviso de Seguridad</h2>
                <p class="text-xs mb-3" style="color:var(--fg2)">La identificaci√≥n de setas requiere conocimientos. Consulta siempre con un experto.</p>
                <label class="text-xs flex items-center justify-center gap-2 mb-3">
                    <input type="checkbox" id="noWarn">
                    No mostrar de nuevo
                </label>
                <button id="acceptBtn" class="btn w-full">Entiendo</button>
            </div>
        </div>
    </div>

    <div id="locModal" class="modal hidden">
        <div class="modal-content p-4">
            <h2 id="locTitle" class="font-bold mb-3" style="color:var(--accent)">Nueva ubicaci√≥n</h2>
            <input id="locNameIn" class="w-full rounded px-3 py-2 mb-2 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="Nombre">
            <input id="locLat" type="hidden">
            <input id="locLon" type="hidden">
            <select id="locForest" class="w-full rounded px-3 py-2 mb-3 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)">
                <option value="hayedo">Hayedo</option>
                <option value="pinar">Pinar</option>
                <option value="robledal">Robledal</option>
                <option value="carrascal">Carrascal</option>
                <option value="pastos">Pastos</option>
            </select>
            <div class="flex gap-2">
                <button id="cancelLoc" class="btn2 flex-1 text-sm">Cancelar</button>
                <button id="saveLoc" class="btn flex-1 text-sm">Guardar</button>
            </div>
        </div>
    </div>

    <div id="mushModal" class="modal hidden">
        <div class="modal-content modal-lg">
            <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 id="mushName" class="font-bold text-xl">-</h2>
                        <p id="mushNames" class="text-sm" style="color:var(--accent2)">-</p>
                    </div>
                    <button id="closeMush" style="color:var(--muted);font-size:1.25rem;background:none;border:none;cursor:pointer">‚úï</button>
                </div>
                <div id="mushContent"></div>
            </div>
        </div>
    </div>

    <div id="noteModal" class="modal hidden">
        <div class="modal-content p-4">
            <h2 class="font-bold mb-3" style="color:var(--accent)">Cuaderno</h2>
            <select id="noteMush" class="w-full rounded px-2 py-1 mb-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)"><option value="">Seta</option></select>
            <input id="noteLoc" class="w-full rounded px-2 py-1 mb-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="Ubicaci√≥n">
            <div class="flex gap-1 mb-2">
                <input id="noteQty" class="flex-1 rounded px-2 py-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="g">
                <input id="noteDate" type="date" class="rounded px-2 py-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)">
            </div>
            <textarea id="noteText" class="w-full rounded px-2 py-1 text-sm" style="background:var(--bg2);border:1px solid var(--border);color:var(--fg)" placeholder="Notas" rows="2"></textarea>
            <button id="addNote" class="btn w-full mt-2 text-sm">Guardar</button>
            <div id="notesList" class="mt-3 text-xs max-h-40 overflow-y-auto"></div>
        </div>
    </div>

    <div id="historyModal" class="modal hidden">
        <div class="modal-content p-4">
            <h2 class="font-bold mb-3" style="color:var(--accent)">Hist√≥rico</h2>
            <button id="saveCapture" class="btn w-full text-sm mb-3">üì∑ Guardar captura</button>
            <div id="captureList" class="space-y-2 max-h-64 overflow-y-auto text-xs"></div>
        </div>
    </div>

    <script>
    // ========== COMARCAS ==========
    const COMARCAS = [
        {id:'piri',n:{es:'Pirineo Navarro',eu:'Nafarroako Pirinioak'},c:[42.85,-0.90],b:[[42.6,-1.2],[43.1,-0.5]],f:['pinar','hayedo']},
        {id:'hum',n:{es:'Navarra H√∫meda',eu:'Nafarroa Hezea'},c:[43.05,-1.65],b:[[42.85,-2.0],[43.3,-1.35]],f:['robledal','hayedo']},
        {id:'pam',n:{es:'Cuenca Pamplona',eu:'Iru√±erria'},c:[42.82,-1.64],b:[[42.65,-1.85],[43.0,-1.45]],f:['robledal','pinar']},
        {id:'meor',n:{es:'Media Oriental',eu:'Ekialde Ertaina'},c:[42.65,-1.45],b:[[42.45,-1.65],[42.85,-1.2]],f:['pinar','robledal']},
        {id:'moc',n:{es:'Media Occidental',eu:'Mendebalde Ertaina'},c:[42.68,-2.1],b:[[42.5,-2.4],[42.85,-1.8]],f:['carrascal','robledal']},
        {id:'rib',n:{es:'La Ribera',eu:'Erribera'},c:[42.15,-1.65],b:[[41.9,-2.1],[42.45,-1.25]],f:['pastos','carrascal']},
        {id:'gipin',n:{es:'Gipuzkoa Interior',eu:'Gipuzkoa Barnealdea'},c:[43.08,-2.2],b:[[42.9,-2.5],[43.25,-1.95]],f:['robledal','hayedo']},
        {id:'gico',n:{es:'Gipuzkoa Costa',eu:'Gipuzkoa Kosta'},c:[43.28,-2.1],b:[[43.15,-2.35],[43.4,-1.85]],f:['robledal']},
        {id:'aln',n:{es:'√Ålava Norte',eu:'Araba Iparraldea'},c:[42.95,-2.9],b:[[42.8,-3.1],[43.1,-2.65]],f:['robledal','hayedo']},
        {id:'als',n:{es:'√Ålava Sur',eu:'Araba Hegoaldea'},c:[42.6,-2.55],b:[[42.4,-2.85],[42.8,-2.3]],f:['carrascal','pastos']},
        {id:'husc',n:{es:'Pirineos Huesca',eu:'Hueskako Pirinioak'},c:[42.6,-0.6],b:[[42.35,-0.95],[42.85,-0.3]],f:['pinar','hayedo']},
        {id:'rioja',n:{es:'Rioja Alta',eu:'Errioxa Garaia'},c:[42.4,-2.8],b:[[42.2,-3.15],[42.6,-2.45]],f:['hayedo','robledal']}
    ];

    // ========== MUSHROOMS CON DATOS COMPLETOS ==========
    const MUSH = [
        {
            id:'b_edu',
            sc:'Boletus edulis',
            nm:{es:'Porcini / Hongo blanco', eu:'Odolki / Onttoin zuri'},
            ds:{
                es:'Seta muy apreciada. Sombrero de 8-25 cm, hemisf√©rico de joven, luego convexo, color pardo variable. Poros blancos, luego amarillentos, NUNCA azules al tacto. Pie robusto, bulboso, con ret√≠culo blanco en la parte superior.',
                eu:'Seta oso balotsua. Kapela 8-25 cm, hemisferikoa gazte, gero ganbila, marroi aldakorra. Poro zuriak, gero horixkak, INOIZ EZ urdinak.'
            },
            sz:{c:[8,25], h:[8,20]},
            ss:[9,10,11],
            ssLab:{es:'Septiembre - Noviembre', eu:'Iraila - Azaroa'},
            fs:['hayedo','pinar','robledal'],
            fsLab:{es:'Hayedos, pinares y robledales', eu:'Pagadiak, pinudiak eta hariztiak'},
            t:[10,18], h:[65,85], r:20, q:5, tg:['autumn'],
            sp:{es:'Oliv√°cea a pardo oliv√°cea', eu:'Olibaxka marroixeria'},
            features:{
                es:[
                    'Sombrero pardo, irregular, superficie lisa o ligeramente viscosa con lluvia',
                    'Poros BLANCOS que amarillean, NUNCA azules al tacto',
                    'Pie grueso con RET√çCULO BLANCO en la parte superior',
                    'Carne BLANCA, compacta, que NO cambia de color al corte',
                    'SIN anillo ni volva'
                ],
                eu:[
                    'Kapela marroia, irregularra, leuna edo pixka bat likatsua euriarekin',
                    'Poro ZURIAK horixkatzen direnak, INOIZ EZ urdinak',
                    'Oin lodia ERRETIKULU ZURIAK goialdean',
                    'Haragi ZURIA, trinkoa, ez da kolorez aldatzen',
                    'Eraztunik ez, bolbarik ez'
                ]
            },
            similar:[
                {sc:'Boletus aereus', nm:{es:'Bola de hierro', eu:'Burdin-bola'}, note:{es:'M√°s oscuro, similar calidad', eu:'Ilunagoa, kalitate antzekoa'}},
                {sc:'Boletus reticulatus', nm:{es:'Hongo de verano', eu:'Udako odolki'}, note:{es:'M√°s claro, ret√≠culo m√°s extenso', eu:'Argiagoa'}},
                {sc:'Boletus pinophilus', nm:{es:'Hongo de pino', eu:'Pinu-odolki'}, note:{es:'Color vino en el sombrero', eu:'Ardo kolorea kapelan'}}
            ],
            conf:[
                {sc:'Boletus satanas', nm:{es:'Bola de nieve', eu:'Elur-bola'}, tx:'toxic', diff:{
                    es:['Poros ROJOS desde joven', 'Carne azulea INTENSAMENTE al corte', 'Pie muy bulboso, rojizo', 'Olor DESAGRADABLE'],
                    eu:['Poro GORRIAK gaztetik', 'Haragia ASKO URDINTZEN da', 'Oin oso erraboilduna, gorrixka', 'KIRATS desatsegina']
                }}
            ]
        },
        {
            id:'l_del',
            sc:'Lactarius deliciosus',
            nm:{es:'N√≠scalo / Robell√≥n', eu:'Esnegorri / Zizahori'},
            ds:{
                es:'Una de las setas m√°s populares. Sombrero de 5-15 cm, deprimido en el centro, naranja con zonas conc√©ntricas m√°s oscuras. L√°tex anaranjado que se vuelve verdoso. Se ti√±e de verde al envejecer.',
                eu:'Seta arrakastatsuenetakoa. Kapela 5-15 cm, erdian deprimitua, laranja gune kontzentriko ilunagoekin. Late laranja berde bihurtzen dena.'
            },
            sz:{c:[5,15], h:[3,8]},
            ss:[9,10,11,12],
            ssLab:{es:'Septiembre - Diciembre', eu:'Iraila - Abendua'},
            fs:['pinar'],
            fsLab:{es:'Pinares de pino silvestre', eu:'Pinu gorriaren pinudiak'},
            t:[8,16], h:[60,80], r:15, q:4, tg:['autumn'],
            sp:{es:'Crema p√°lido', eu:'Krema zurbila'},
            features:{
                es:[
                    'Zonas CONC√âNTRICAS m√°s oscuras sobre fondo naranja',
                    'L√°tex NARANJA ABUNDANTE que se vuelve verde',
                    'Laminillas DECURRENTES, anaranjadas, manchadas de verde',
                    'Se ti√±e de VERDE al manipularlo o al envejecer',
                    'EXCLUSIVO de pinares'
                ],
                eu:[
                    'Gune KONTZENTRIKO ilunagoak laranja gainean',
                    'Late LARANJA UGARI berde bihurtzen dena',
                    'Orri DEKURRENTEAK, laranjak, berdez zikinak',
                    'BERDE bihurtzen da manipulatzean',
                    'PINUDIETAN BAKARRIK'
                ]
            },
            similar:[],
            conf:[
                {sc:'Lactarius torminosus', nm:{es:'Falso n√≠scalo', eu:'Falso esnegorri'}, tx:'toxic', diff:{
                    es:['Borde con PELO ALGODONOSO', 'L√°tex BLANCO abundante', 'Sabor MUY PICANTE', 'En abedules, NO pinos'],
                    eu:['Ertza ILE KOTOIKARAREKIN', 'Late ZURIA ugari', 'Zapore OSO MINA', 'URKIAN, EZ pinuetan']
                }}
            ]
        },
        {
            id:'c_cib',
            sc:'Cantharellus cibarius',
            nm:{es:'Rebozuelo / Chantarela', eu:'Ziza hori / Kurrilo'},
            ds:{
                es:'Excelente comestible. Sombrero de 3-10 cm, amarillo huevo, deprimido en forma de embudo. Pseudolaminillas decurrentes, bifurcadas, del mismo color. Carne firme, olor afrutado caracter√≠stico.',
                eu:'Jangarri bikaina. Kapela 3-10 cm, arrautza horia, inbutu forman. Pseudo-orri dekurrenteak. Fruta usain bereizgarria.'
            },
            sz:{c:[3,10], h:[3,7]},
            ss:[6,7,8,9,10,11],
            ssLab:{es:'Junio - Noviembre', eu:'Ekaina - Azaroa'},
            fs:['hayedo','robledal','pinar'],
            fsLab:{es:'Bosques mixtos', eu:'Baso mistoak'},
            t:[12,22], h:[55,75], r:20, q:5, tg:['summer','autumn'],
            sp:{es:'Amarillo p√°lido', eu:'Hori zurbila'},
            features:{
                es:[
                    'Color AMARILLO HUEVO uniforme',
                    'Pseudolaminillas (NO l√°minas verdaderas), SE BIFURCAN',
                    'Carne FIRME, no se rompe f√°cilmente',
                    'OLOR AFRUTADO muy caracter√≠stico',
                    'Crece en grupos, a veces en "corros de brujas"'
                ],
                eu:[
                    'ARRAUTZA HORI kolore uniformea',
                    'Pseudo-orriak (ez orri benetakoak), ADARKATUAK',
                    'Haragi SENDOA, ez da erraz apurtzen',
                    'FRUTA USAIN bereizgarria',
                    'Taldeetan hazten da'
                ]
            },
            similar:[
                {sc:'Cantharellus tubaeformis', nm:{es:'Rebozuelo tard√≠o', eu:'Ziza hori berantiar'}, note:{es:'M√°s peque√±o, pie hueco', eu:'Txikiagoa, oin hustua'}},
                {sc:'Craterellus cornucopioides', nm:{es:'Trompeta de muertos', eu:'Hildakoen tronpeta'}, note:{es:'M√°s oscuro, sin olor', eu:'Ilunagoa, usainik ez'}}
            ],
            conf:[
                {sc:'Omphalotus olearius', nm:{es:'Falso rebozuelo', eu:'Falso ziza hori'}, tx:'toxic', diff:{
                    es:['Crece en TOCONES y madera muerta', 'L√°minas VERDADERAS, finas y apretadas', 'Color naranja M√ÅS INTENSO', 'NO tiene olor afrutado'],
                    eu:['MOINGONDOETAN eta EGUR HILETAN', 'Orri BENA BEREKOAK, finak', 'Laranja INTENTSUAGO', 'EZ du fruta usainik']
                }}
            ]
        },
        {
            id:'a_rub',
            sc:'Amanita rubescens',
            nm:{es:'Amanita vinosa', eu:'Amanita arrosa'},
            ds:{
                es:'Comestible SOLO BIEN COCINADA (cruda es t√≥xica). Sombrero pardo-rojizo con escamas grises. VOLVA AUSENTE. Carne enrojece lentamente al corte. ESPORADA BLANCA.',
                eu:'JAN BEHAR DA ONDO EGOSITA (gordina toxikoa da). Bolbarik ez. Haragia gorritu egiten da. ESPORADA ZURIA.'
            },
            sz:{c:[6,15], h:[6,15]},
            ss:[6,7,8,9,10],
            ssLab:{es:'Junio - Octubre', eu:'Ekaina - Urria'},
            fs:['robledal','hayedo','pinar'],
            fsLab:{es:'Bosques variados', eu:'Baso anitzak'},
            t:[14,22], h:[60,80], r:25, q:3, tg:['summer','autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'Sombrero pardo-rojizo con ESCAMAS GRISES',
                    'Anillo ESTRIADO (con rayas)',
                    'SIN VOLVA (¬°importante distinguir de A. pantherina!)',
                    'Carne ENROJECE al corte lentamente',
                    'ESPORADA BLANCA'
                ],
                eu:[
                    'Kapela marroi-gorrixka EZKATA GRISEKIN',
                    'Eraztun ILDASKATUA',
                    'BOLBARIK EZ (garrantzitsua!)',
                    'Haragia GORRITU egiten da',
                    'ESPORADA ZURIA'
                ]
            },
            similar:[],
            conf:[
                {sc:'Amanita pantherina', nm:{es:'Amanita pantera', eu:'Amanita pantera'}, tx:'toxic', diff:{
                    es:['Escamas BLANCAS sobre fondo gris√°ceo', 'Anillo LISO (sin rayas)', 'VOLVA PRESENTE en la base', 'Carne NO enrojece', '¬°PUEDE SER MORTAL!'],
                    eu:['Ezkata ZURIAK gris gainean', 'Eraztun LEUNA', 'BOLBA BADU oinarrian', 'Haragia EZ da gorritzen', 'HERIOKORRA IZAN DAITEKE!']
                }}
            ]
        },
        {
            id:'h_rep',
            sc:'Hydnum repandum',
            nm:{es:'Lengua de buey', eu:'Arantza-ziza'},
            ds:{
                es:'Deliciosa seta f√°cil de identificar. Sombrero amarillo p√°lido, irregular, deprimido. ESPINAS en lugar de l√°minas. Carne quebradiza.',
                eu:'Seta goxoa, identifikatzeko erraza. Kapela hori zurbila, irregularra. ARANTZAK orrien ordez.'
            },
            sz:{c:[5,15], h:[3,8]},
            ss:[8,9,10,11],
            ssLab:{es:'Agosto - Noviembre', eu:'Abuztua - Azaroa'},
            fs:['hayedo','robledal','pinar'],
            fsLab:{es:'Bosques de con√≠feras y frondosas', eu:'Konifero eta hostozabalen basoak'},
            t:[10,18], h:[65,85], r:20, q:4, tg:['autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'ESPINAS en la parte inferior (NO l√°minas)',
                    'Color amarillo p√°lido UNIFORME',
                    'Sombrero IRREGULAR, ondulado',
                    'Carne BLANCA, quebradiza',
                    'Sin l√°minas ni poros'
                ],
                eu:[
                    'ARANTZAK azpialdean (EZ orriak)',
                    'Hori zurbil UNIFORMEA',
                    'Kapela IRREGULARRA, uhindua',
                    'Haragi ZURIA, hauskorra',
                    'Orririk ez, pororik ez'
                ]
            },
            similar:[
                {sc:'Hydnum rufescens', nm:{es:'Lengua de gato', eu:'Katu-mihia'}, note:{es:'M√°s peque√±o, espinas m√°s cortas', eu:'Txikiagoa, arantza motzagoak'}}
            ],
            conf:[]
        },
        {
            id:'c_cor',
            sc:'Craterellus cornucopioides',
            nm:{es:'Trompeta de los muertos', eu:'Hildakoen tronpeta'},
            ds:{
                es:'Excelente comestible. Fructificaci√≥n de 3-8 cm en forma de trompeta, gris-negruzca, COMPLETAMENTE HUECA. Carne fina, muy arom√°tica.',
                eu:'Jangarri bikaina. 3-8 cm tronpeta forman, gris-beltzaxka, ERABAT HUSTUA. Usain atsegina.'
            },
            sz:{c:[3,8], h:[5,10]},
            ss:[9,10,11],
            ssLab:{es:'Septiembre - Noviembre', eu:'Iraila - Azaroa'},
            fs:['hayedo','robledal'],
            fsLab:{es:'Hayedos y robledales h√∫medos', eu:'Pagadi eta harizti hezeak'},
            t:[10,16], h:[70,90], r:30, q:5, tg:['autumn'],
            sp:{es:'Blanquecina', eu:'Zurixka'},
            features:{
                es:[
                    'Forma de TROMPETA o cuerno',
                    'Color GRIS OSCURO a negruzco',
                    'COMPLETAMENTE HUECA por dentro',
                    'SIN l√°minas ni poros (superficie lisa)',
                    'Olor muy AROM√ÅTICO'
                ],
                eu:[
                    'TRONPETA edo adar forma',
                    'Kolore GRIS ILUNA beltxeraino',
                    'ERABAT HUSTUA barrutik',
                    'Orririk ez, pororik ez',
                    'Usain ARMATUA'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'t_ter',
            sc:'Tricholoma terreum',
            nm:{es:'Seta de pino / Negrilla', eu:'Pinu-ziza / Beltx'},
            ds:{
                es:'Comestible apreciado. Sombrero de 4-10 cm, gris con fibrillas radiales m√°s oscuras. Olor harinoso.',
                eu:'Jangarri balotsua. Kapela 4-10 cm, grisa ile ilunagoekin. Irin usaina.'
            },
            sz:{c:[4,10], h:[4,10]},
            ss:[10,11,12],
            ssLab:{es:'Octubre - Diciembre', eu:'Urria - Abendua'},
            fs:['pinar'],
            fsLab:{es:'Pinares', eu:'Pinudiak'},
            t:[6,14], h:[60,80], r:15, q:3, tg:['autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'Sombrero GRIS con fibrillas radiales',
                    'Superficie aterciopelada o escamosa',
                    'Laminillas BLANCAS a grises',
                    'Olor HARINOSO d√©bil',
                    'EXCLUSIVO de pinares'
                ],
                eu:[
                    'Kapela GRISA ile erradialekin',
                    'Azal beluduna edo ezkataleurra',
                    'Orri ZURIK grisera',
                    'Irin usain ahula',
                    'PINUDIETAN BAKARRIK'
                ]
            },
            similar:[
                {sc:'Tricholoma portentosum', nm:{es:'Seta de los caballeros', eu:'Zaldunen ziza'}, note:{es:'M√°s grande, sombrero viscoso', eu:'Handiagoa, kapela likatsua'}}
            ],
            conf:[]
        },
        {
            id:'l_nud',
            sc:'Lepista nuda',
            nm:{es:'Pie azul', eu:'Oin urdin'},
            ds:{
                es:'Buena comestible. Sombrero lil√°ceo que se vuelve marr√≥n. Laminillas lil√°ceas muy juntas. Olor fragante.',
                eu:'Jangarri ona. Kapela morea marroira. Orri more estuak.'
            },
            sz:{c:[6,15], h:[5,12]},
            ss:[9,10,11,12],
            ssLab:{es:'Septiembre - Diciembre', eu:'Iraila - Abendua'},
            fs:['hayedo','robledal','pinar','pastos'],
            fsLab:{es:'Bosques, jardines, vi√±edos', eu:'Basoak, lorategiak'},
            t:[8,16], h:[65,85], r:25, q:4, tg:['autumn'],
            sp:{es:'Rosa p√°lido', eu:'Arrosa zurbila'},
            features:{
                es:[
                    'Color LIL√ÅCEO (violeta) caracter√≠stico',
                    'Laminillas MUY JUNTAS, decurrentes',
                    'Pie con tonos violetas',
                    'Olor FRAGANTE',
                    'Crece a menudo en corros'
                ],
                eu:[
                    'Kolore MOREA bereizgarria',
                    'Orri OSO ESTU, dekurrenteak',
                    'Oin kolore moreekin',
                    'Usain LIRAINA',
                    'Taldeetan'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'t_mel',
            sc:'Tuber melanosporum',
            nm:{es:'Trufa negra', eu:'Trufa beltza'},
            ds:{
                es:'La joya de la micolog√≠a. Cuerpo subterr√°neo de 3-7 cm, negro parduzco con verrugas piramidales. Aroma muy intenso.',
                eu:'Mikologiaren bitxia. Lurperako 3-7 cm, beltz-marroia garatxo piramidalekin. Usain oso sendoa.'
            },
            sz:{c:[3,7], h:[0,0]},
            ss:[11,12,1,2,3],
            ssLab:{es:'Noviembre - Marzo', eu:'Azaroa - Martxoa'},
            fs:['carrascal'],
            fsLab:{es:'Carrascales calc√°reos', eu:'Artadi karetiak'},
            t:[5,12], h:[60,80], r:25, q:5, tg:['winter'],
            sp:{es:'Negra', eu:'Beltza'},
            features:{
                es:[
                    'Crece BAJO TIERRA (hipogea)',
                    'Superficie NEGRA con VERRUGAS PIRAMIDALES',
                    'Carne gris-negra con VENAS BLANCAS',
                    'AROMA MUY INTENSO y caracter√≠stico',
                    'Necesita perros truferos para localizarla'
                ],
                eu:[
                    'LURPEAN hazten da',
                    'Azal BELTZA GARATXO PIRAMIDALEKIN',
                    'Haragi gris-beltza ZAIN ZURIEKIN',
                    'USAIN SENDOA',
                    'Trufa-txakurrak behar dira'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'h_mar',
            sc:'Hygrophorus marzuolus',
            nm:{es:'Seta de marzo', eu:'Martxoko ziza'},
            ds:{
                es:'La primera seta del a√±o. Sombrero blanco a gris oscuro, manchado de negro. Carne blanca.',
                eu:'Urteko lehen seta. Kapela zuria gris ilunera, beltzez zipriztindua.'
            },
            sz:{c:[4,10], h:[4,10]},
            ss:[3,4,5],
            ssLab:{es:'Marzo - Mayo', eu:'Martxoa - Maiatza'},
            fs:['pinar','hayedo','robledal'],
            fsLab:{es:'Pinares, hayedos y robledales', eu:'Pinudiak, pagadiak, hariztiak'},
            t:[5,14], h:[70,90], r:30, q:4, tg:['spring'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'PRIMERA SETA de la temporada (marzo-abril)',
                    'MANCHAS NEGRAS sobre fondo blanco/gris',
                    'Aparece entre la NIEVE derretida',
                    'Laminillas BLANCAS, muy ESPACIADAS',
                    'A menudo semienterrada'
                ],
                eu:[
                    'DENBORALDIKO LEHEN SETA (martxo-apirila)',
                    'ORBAN BELTZAK zuri/gris gainean',
                    'ELUR URRIAREN ARTEAN',
                    'Orri ZURIK, oso ZABALAK',
                    'Maiz erdi lurperatuta'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'c_gam',
            sc:'Calocybe gambosa',
            nm:{es:'Perretxiko / San Mart√≠n', eu:'Perretxiko'},
            ds:{
                es:'Muy apreciada en Euskal Herria. Sombrero blanco a crema, liso. Laminillas MUY APRETADAS. Olor harinoso fuerte.',
                eu:'Oso balotsua Euskal Herrian. Kapela zuria kremara. Orri OSO ESTU. Irin usain sendoa.'
            },
            sz:{c:[4,12], h:[4,10]},
            ss:[4,5,6],
            ssLab:{es:'Abril - Junio', eu:'Apirila - Ekaina'},
            fs:['pastos','robledal'],
            fsLab:{es:'Praderas y robledales', eu:'Belardiak eta hariztiak'},
            t:[10,18], h:[60,80], r:25, q:5, tg:['spring'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'Color BLANCO a crema uniforme',
                    'Laminillas MUY APRETADAS, sinuadas',
                    'Olor HARINOSO FUERTE caracter√≠stico',
                    'Pie ROBUSTO, macizo',
                    'Crece en "corros de brujas"'
                ],
                eu:[
                    'ZURI-KREMA kolore uniformea',
                    'Orri OSO ESTU',
                    'IRIN USAIN SENDOA',
                    'Oin SENDOA, trinkoa',
                    '"Sorgin eraztunetan"'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'a_cam',
            sc:'Agaricus campestris',
            nm:{es:'Champi√±√≥n de prado', eu:'Belardi-champi√±oi'},
            ds:{
                es:'El champi√±√≥n silvestre. Sombrero blanco, escamoso. Laminillas rosadas luego marrones. Anillo fugaz.',
                eu:'Champi√±oi basatia. Kapela zuria, ezkataleurra. Orri arrosak gero marroiak.'
            },
            sz:{c:[4,10], h:[3,8]},
            ss:[4,5,6,9,10,11],
            ssLab:{es:'Primavera y Oto√±o', eu:'Udaberria eta Udazkena'},
            fs:['pastos'],
            fsLab:{es:'Praderas y c√©spedes', eu:'Belardiak'},
            t:[12,20], h:[55,75], r:15, q:4, tg:['spring','autumn'],
            sp:{es:'Marr√≥n oscuro', eu:'Marroi iluna'},
            features:{
                es:[
                    'Sombrero BLANCO, a veces escamoso',
                    'Laminillas ROSADAS que se vuelven marrones',
                    'Anillo PEQUE√ëO y fugaz',
                    'Carne enrojece LIGERAMENTE al corte',
                    'En praderas, nunca en bosque'
                ],
                eu:[
                    'Kapela ZURIA, batzuetan ezkataleurra',
                    'Orri ARROSAK marroi bihurtzen dira',
                    'Eraztun TXIKIA eta iheskorria',
                    'Haragia GORRITU pixka bat',
                    'Belardietan, inoiz ez basoan'
                ]
            },
            similar:[
                {sc:'Agaricus arvensis', nm:{es:'Champi√±√≥n de caballo', eu:'Zaldi-champi√±oi'}, note:{es:'M√°s grande, anillo m√°s grueso', eu:'Handiagoa'}}
            ],
            conf:[
                {sc:'Amanita verna', nm:{es:'Amanita de primavera', eu:'Udaberriko amanita'}, tx:'toxic', diff:{
                    es:['Laminillas BLANCAS (no rosadas)', 'Volva PRESENTE en la base', 'Anillo bien desarrollado', 'MUY T√ìXICA'],
                    eu:['Orri ZURIAK (ez arrosak)', 'BOLBA BADU oinarrian', 'Eraztun garbi garbia', 'OSO TOXIKOA']
                }}
            ]
        },
        {
            id:'m_pro',
            sc:'Macrolepiota procera',
            nm:{es:'Parasol', eu:'Aterki-handi'},
            ds:{
                es:'Impresionante por su tama√±o. Sombrero de 10-30 cm con escamas marrones. Pie muy alto con anillo m√≥vil.',
                eu:'Tamainuagatik ikusgarria. Kapela 10-30 cm ezkata marroiekin. Oin oso altua eraztun mugikorrarekin.'
            },
            sz:{c:[10,30], h:[15,35]},
            ss:[6,7,8,9,10],
            ssLab:{es:'Junio - Octubre', eu:'Ekaina - Urria'},
            fs:['pastos','pinar'],
            fsLab:{es:'Praderas y claros de bosque', eu:'Belardiak eta basoetako zabalgunak'},
            t:[14,22], h:[50,70], r:15, q:4, tg:['summer','autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'Sombrero MUY GRANDE con escamas marrones',
                    'Pie MUY ALTO, delgado',
                    'Anillo DOBLE y M√ìVIL (se desliza)',
                    'Chapitel oscuro en el centro',
                    'Laminillas BLANCAS, libres'
                ],
                eu:[
                    'Kapela OSO HANDIA ezkata marroiekin',
                    'Oin OSO ALTUA, mehea',
                    'Eraztun BIKOITZA eta MUGIKORRA',
                    'Punta iluna erdian',
                    'Orri ZURIAK'
                ]
            },
            similar:[],
            conf:[
                {sc:'Chlorophyllum molybdites', nm:{es:'Falso parasol', eu:'Falso aterki-handi'}, tx:'toxic', diff:{
                    es:['Laminillas VERDOSAS en madurez', 'Sombrero m√°s liso', 'No tiene el chapitel oscuro', 'T√ìXICO'],
                    eu:['Orri BERDEXKAK heldutasunean', 'Kapela leunagoa', 'Ez du punta ilun', 'TOXIKOA']
                }}
            ]
        },
        {
            id:'m_ore',
            sc:'Marasmius oreades',
            nm:{es:'Senderuela', eu:'Bide-ziza'},
            ds:{
                es:'Peque√±a pero excelente. Sombrero ocre con mamel√≥n pronunciado. Forma "corros de brujas".',
                eu:'Txikia baina bikaina. Kapela okrea mameloi nabarmenarekin. "Sorgin eraztunak".'
            },
            sz:{c:[2,5], h:[4,8]},
            ss:[5,6,7,8,9,10],
            ssLab:{es:'Mayo - Octubre', eu:'Maiatza - Urria'},
            fs:['pastos'],
            fsLab:{es:'Praderas y c√©spedes', eu:'Belardiak'},
            t:[14,22], h:[50,70], r:10, q:4, tg:['spring','summer','autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'MAMEL√ìN PRONUNCIADO en el centro',
                    'Color OCRE uniforme',
                    'Crece formando CORROS DE BRUJAS',
                    'Carne fina, aroma agradable',
                    'REVIVE con la humedad'
                ],
                eu:[
                    'MAMELOI NABARMENA erdian',
                    'OKRE kolore uniformea',
                    '"SORGIN ERAZTUNAK" osatzen ditu',
                    'Haragi fina',
                    'BERPIZTU egiten da hezetasunarekin'
                ]
            },
            similar:[],
            conf:[
                {sc:'Clitocybe rivulosa', nm:{es:'Clitocibe t√≥xico', eu:'Clitocibe toxikoa'}, tx:'toxic', diff:{
                    es:['SIN mamel√≥n (sombrero plano)', 'Laminillas m√°s apretadas, decurrentes', 'Crece tambi√©n en corros', 'MUY T√ìXICO'],
                    eu:['Mameloirik EZ (kapela laua)', 'Orri estuagoak, dekurrenteak', 'Eraztunak osatzen ditu', 'OSO TOXIKOA']
                }}
            ]
        },
        {
            id:'r_cya',
            sc:'Russula cyanoxantha',
            nm:{es:'Carbonera', eu:'Russula urdin'},
            ds:{
                es:'Muy variable en color (violeta, verde, p√∫rpura). Laminillas FLEXIBLES y GRASIENTAS al tacto.',
                eu:'Kolore aldakorra (morea, berdea, purpura). Orri MALGUAK eta KOIPETSUAK.'
            },
            sz:{c:[6,15], h:[4,10]},
            ss:[6,7,8,9,10],
            ssLab:{es:'Junio - Octubre', eu:'Ekaina - Urria'},
            fs:['robledal','hayedo'],
            fsLab:{es:'Hayedos y robledales', eu:'Pagadiak eta hariztiak'},
            t:[12,20], h:[55,75], r:20, q:4, tg:['summer','autumn'],
            sp:{es:'Blanca', eu:'Zuria'},
            features:{
                es:[
                    'COLORES MUY VARIABLES en el mismo ejemplar',
                    'Laminillas FLEXIBLES (se doblan sin romperse)',
                    'Tacto GRASIENTO en las laminillas',
                    'Sabor DULCE (no picante)',
                    'Pie quebradizo como tiza'
                ],
                eu:[
                    'KOLORE OSO ALDAKORRA',
                    'Orri MALGUAK (tolestu egiten dira apurtu gabe)',
                    'Ukipen KOIPETSUA orrietan',
                    'Zapore GOZOA',
                    'Oin hauskorra'
                ]
            },
            similar:[],
            conf:[]
        },
        {
            id:'s_gra',
            sc:'Suillus granulatus',
            nm:{es:'Bokete / Mikel', eu:'Bokete'},
            ds:{
                es:'T√≠pico de pinares. Sombrero pardo-amarillento, viscoso con lluvia. Poros amarillos con gotitas.',
                eu:'Pinudietakoa. Kapela marroi-horixka, likatsua. Poro horiak tantekin.'
            },
            sz:{c:[5,12], h:[4,9]},
            ss:[9,10,11],
            ssLab:{es:'Septiembre - Noviembre', eu:'Iraila - Azaroa'},
            fs:['pinar'],
            fsLab:{es:'Pinares', eu:'Pinudiak'},
            t:[10,18], h:[55,75], r:15, q:3, tg:['autumn'],
            sp:{es:'Oliv√°cea', eu:'Olibaxka'},
            features:{
                es:[
                    'Sombrero VISCOSO con lluvia',
                    'POROS AMARILLOS con GOTITAS en j√≥venes',
                    'SIN anillo',
                    'Debajo de PINOS',
                    'Pie con granulaciones'
                ],
                eu:[
                    'Kapela LIKATSUA euriarekin',
                    'PORO HORI TANTEKIN gazteetan',
                    'ERAZTUNIK EZ',
                    'PINUEN AZPIAN',
                    'Oin pikortsua'
                ]
            },
            similar:[
                {sc:'Suillus luteus', nm:{es:'Bokete de anillo', eu:'Eraztun-bokete'}, note:{es:'Con anillo, poros m√°s oscuros', eu:'Eraztunarekin'}}
            ],
            conf:[]
        }
    ];

    // ========== ESTADO ==========
    let lang = localStorage.getItem('mico_lang') || 'es';
    let saved = JSON.parse(localStorage.getItem('mico_saved') || '[]');
    let notes = JSON.parse(localStorage.getItem('mico_notes') || '[]');
    let captures = JSON.parse(localStorage.getItem('mico_captures') || '[]');
    let map = null;
    let cData = {};
    let selLoc = null;
    let wData = null;
    let activeSeason = 'all';
    let activeHabitat = null;
    let adj = { forest: null, orient: '', zone: '', alt: 0 };

    const $ = id => document.getElementById(id);

    // ========== TOGGLE COLLAPSE ==========
    function toggleCollapse(id) {
        const el = $(id);
        const isOpen = el.classList.contains('open');
        el.classList.toggle('open');
        
        // Toggle arrow
        if (id === 'adjCollapse') {
            $('adjArrow').textContent = isOpen ? '‚ñº' : '‚ñ≤';
        } else if (id === 'calcCollapse') {
            $('calcArrow').textContent = isOpen ? '‚ñº' : '‚ñ≤';
        }
    }
    
    // Make toggleCollapse globally available
    window.toggleCollapse = toggleCollapse;

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        renderSaved();
        renderNotes();
        renderGuide();
        renderCaptures();
        populateMushSelect();
        bindEvents();
        $('noteDate').valueAsDate = new Date();
        
        if (localStorage.getItem('mico_safe') !== '1') {
            $('safetyModal').classList.remove('hidden');
        }
        
        renderForestBtns();
    });

    function bindEvents() {
        $('acceptBtn').onclick = () => {
            if ($('noWarn').checked) localStorage.setItem('mico_safe', '1');
            $('safetyModal').classList.add('hidden');
        };
        
        $('langBtn').onclick = () => {
            lang = lang === 'es' ? 'eu' : 'es';
            localStorage.setItem('mico_lang', lang);
            $('langBtn').textContent = lang.toUpperCase();
            renderAll();
        };
        
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                b.classList.add('active');
                document.querySelectorAll('main > section').forEach(s => s.classList.toggle('hidden', s.id !== 'tab-' + b.dataset.tab));
                if (map) setTimeout(() => map.invalidateSize(), 50);
            };
        });
        
        $('noteBtn').onclick = () => $('noteModal').classList.remove('hidden');
        $('historyBtn').onclick = () => $('historyModal').classList.remove('hidden');
        $('addNote').onclick = addNote;
        
        $('searchBtn').onclick = searchLoc;
        $('searchIn').onkeypress = e => { if (e.key === 'Enter') searchLoc(); };
        
        document.querySelectorAll('.season').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.season').forEach(x => { x.style.background = 'var(--bg2)'; x.classList.remove('active'); });
                b.style.background = 'var(--accent)';
                b.classList.add('active');
                activeSeason = b.dataset.f;
                renderGuide();
            };
        });
        
        document.querySelectorAll('.habitat').forEach(b => {
            b.onclick = () => {
                const was = b.classList.contains('active');
                document.querySelectorAll('.habitat').forEach(x => { x.style.background = 'var(--bg2)'; x.classList.remove('active'); });
                if (!was) {
                    b.style.background = 'var(--accent2)';
                    b.classList.add('active');
                    activeHabitat = b.dataset.h;
                } else {
                    activeHabitat = null;
                }
                renderGuide();
            };
        });
        
        $('mushSearch').oninput = renderGuide;
        
        $('resetAdj').onclick = () => {
            adj = { forest: null, orient: '', zone: '', alt: 0 };
            renderForestBtns();
            document.querySelectorAll('#orientBtns .adj-btn, #zoneBtns .adj-btn, #altBtns .adj-btn').forEach(x => x.classList.remove('active'));
            document.querySelector('#orientBtns [data-o=""]').classList.add('active');
            document.querySelector('#zoneBtns [data-z=""]').classList.add('active');
            document.querySelector('#altBtns [data-a="0"]').classList.add('active');
            renderMush();
            renderCalcDetail();
        };
        
        document.querySelectorAll('#orientBtns .adj-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('#orientBtns .adj-btn').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                adj.orient = b.dataset.o;
                renderMush();
                renderCalcDetail();
            };
        });
        
        document.querySelectorAll('#zoneBtns .adj-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('#zoneBtns .adj-btn').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                adj.zone = b.dataset.z;
                renderMush();
                renderCalcDetail();
            };
        });
        
        document.querySelectorAll('#altBtns .adj-btn').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('#altBtns .adj-btn').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                adj.alt = parseInt(b.dataset.a);
                renderMush();
                renderCalcDetail();
            };
        });
        
        $('closeMush').onclick = () => $('mushModal').classList.add('hidden');
        $('cancelLoc').onclick = () => $('locModal').classList.add('hidden');
        $('saveLoc').onclick = saveLoc;
        $('saveCapture').onclick = saveCapture;
        
        ['safetyModal', 'locModal', 'mushModal', 'noteModal', 'historyModal'].forEach(id => {
            $(id).onclick = e => { if (e.target.id === id) $(id).classList.add('hidden'); };
        });
    }

    function renderAll() {
        renderGuide();
        renderSaved();
        renderTop();
    }

    // ========== MAP ==========
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([42.85, -1.65], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd' }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        
        let i = 0;
        const loadNext = () => {
            if (i >= COMARCAS.length) { renderTop(); return; }
            loadComarca(COMARCAS[i]);
            i++;
            setTimeout(loadNext, 150);
        };
        loadNext();
    }

    async function loadComarca(c) {
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${c.c[0]}&longitude=${c.c[1]}&daily=temperature_2m_mean,precipitation_sum,relative_humidity_2m_mean&past_days=7&timezone=Europe/Madrid`;
            const res = await fetch(url);
            const d = await res.json();
            
            const t = avg(d.daily.temperature_2m_mean.slice(-7));
            const rn = d.daily.precipitation_sum.slice(-7).reduce((a, b) => a + b, 0);
            const h = avg(d.daily.relative_humidity_2m_mean.slice(-7));
            const p = calcProb(t, rn, h, c.f);
            
            cData[c.id] = { ...c, t, rn, h, p };
            L.rectangle(c.b, { color: probCol(p), fillColor: probCol(p), fillOpacity: 0.35, weight: 1 }).addTo(map).bindPopup(`<b>${c.n[lang]}</b><br>${Math.round(p)}%`);
        } catch (e) {
            const p = estProb(c.f);
            cData[c.id] = { ...c, p };
            L.rectangle(c.b, { color: probCol(p), fillColor: probCol(p), fillOpacity: 0.35, weight: 1 }).addTo(map).bindPopup(`<b>${c.n[lang]}</b><br>~${Math.round(p)}%`);
        }
        renderTop();
    }

    function avg(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }

    function calcProb(t, rn, h, f) {
        let p = 0;
        if (t >= 10 && t <= 18) p += 35; else if (t >= 8 && t <= 22) p += 25; else p += 10;
        if (rn >= 20 && rn <= 60) p += 35; else if (rn >= 10) p += 20; else p += 10;
        if (h >= 65 && h <= 85) p += 30; else if (h >= 55) p += 15;
        
        const m = new Date().getMonth() + 1;
        const relevant = MUSH.filter(x => x.fs.some(ff => f.includes(ff)));
        let sf = 0.15;
        for (const x of relevant) {
            if (x.ss.includes(m)) sf = 1;
            else if (x.ss.some(s => Math.abs(s - m) === 1)) sf = 0.7;
        }
        return Math.min(100, Math.round(p * sf));
    }

    function estProb(f) {
        const m = new Date().getMonth() + 1;
        const rel = MUSH.filter(x => x.fs.some(ff => f.includes(ff)));
        let cnt = 0;
        for (const x of rel) {
            if (x.ss.includes(m)) cnt += 1;
            else if (x.ss.some(s => Math.abs(s - m) === 1)) cnt += 0.5;
        }
        return Math.min(100, Math.round((cnt / rel.length) * 100));
    }

    function probCol(p) {
        if (p >= 70) return '#5b9c6b';
        if (p >= 40) return '#d4a855';
        if (p >= 20) return '#c17f59';
        return '#c75b5b';
    }

    function renderTop() {
        const arr = Object.values(cData).sort((a, b) => b.p - a.p).slice(0, 5);
        $('topList').innerHTML = arr.map((c, i) => `
            <div class="flex justify-between p-1 rounded cursor-pointer hover:bg-[var(--bg2)]" onclick="map.setView([${c.c[0]},${c.c[1]}],10)">
                <span>${i + 1}. ${c.n[lang]}</span>
                <span style="color:${probCol(c.p)}">${Math.round(c.p)}%</span>
            </div>
        `).join('');
    }

    // ========== SEARCH ==========
    async function searchLoc() {
        const q = $('searchIn').value.trim();
        if (!q) return;
        $('searchRes').innerHTML = '<span style="color:var(--muted)">...</span>';
        
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=3`);
            const data = await res.json();
            if (!data.length) { $('searchRes').innerHTML = '<span style="color:var(--muted)">Sin resultados</span>'; return; }
            $('searchRes').innerHTML = data.map(x => `<div class="p-1 rounded cursor-pointer hover:bg-[var(--bg2)]" onclick="pickSearch(${x.lat},${x.lon},'${x.display_name.split(',')[0]}')">${x.display_name.split(',')[0]}</div>`).join('');
        } catch (e) { $('searchRes').innerHTML = '<span style="color:var(--danger)">Error</span>'; }
    }

    function pickSearch(lat, lon, name) {
        $('locTitle').textContent = 'Nueva ubicaci√≥n';
        $('locNameIn').value = name;
        $('locLat').value = lat;
        $('locLon').value = lon;
        $('locModal').classList.remove('hidden');
        map.setView([lat, lon], 12);
    }

    function saveLoc() {
        const name = $('locNameIn').value.trim();
        if (!name) { alert('Nombre'); return; }
        const loc = { id: 'c_' + Date.now(), name, lat: parseFloat($('locLat').value), lon: parseFloat($('locLon').value), f: [$('locForest').value] };
        localStorage.setItem('loc_' + loc.id, JSON.stringify(loc));
        if (!saved.includes(loc.id)) saved.push(loc.id);
        localStorage.setItem('mico_saved', JSON.stringify(saved));
        $('locModal').classList.add('hidden');
        renderSaved();
        showLoc(loc);
        document.querySelector('[data-tab="report"]').click();
    }

    // ========== SAVED ==========
    function getLoc(id) { return id.startsWith('c_') ? JSON.parse(localStorage.getItem('loc_' + id)) : null; }

    function renderSaved() {
        const html = saved.map(id => {
            const l = getLoc(id);
            if (!l) return '';
            return `<div class="flex justify-between p-1 rounded text-xs" style="background:var(--bg2)"><span class="cursor-pointer flex-1" onclick="goToLoc('${id}')">${l.name}</span><span class="cursor-pointer" style="color:var(--muted)" onclick="event.stopPropagation();delSaved('${id}')">‚úï</span></div>`;
        }).join('');
        $('savedList').innerHTML = html || '<span style="color:var(--muted)">Guarda ubicaciones</span>';
        $('reportList').innerHTML = html || '<span style="color:var(--muted)">Sin ubicaciones</span>';
    }
    
    function goToLoc(id) {
        const l = getLoc(id);
        if (!l) return;
        document.querySelector('[data-tab="report"]').click();
        showLoc(l);
    }

    function delSaved(id) {
        saved = saved.filter(x => x !== id);
        localStorage.setItem('mico_saved', JSON.stringify(saved));
        if (id.startsWith('c_')) localStorage.removeItem('loc_' + id);
        renderSaved();
    }

    async function showLoc(loc) {
        if (!loc) return;
        selLoc = loc;
        
        $('noLoc').classList.add('hidden');
        $('locInfo').classList.remove('hidden');
        $('locName').textContent = loc.name;
        $('locMeta').textContent = `${loc.lat.toFixed(4)}, ${loc.lon.toFixed(4)}`;
        
        renderForestBtns();
        
        $('wLoad').classList.remove('hidden');
        $('wContent').classList.add('hidden');
        
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,relative_humidity_2m_mean,weather_code,wind_speed_10m_max&past_days=7&timezone=Europe/Madrid`;
            const res = await fetch(url);
            const d = await res.json();
            
            wData = { t: d.daily.temperature_2m_max[6], tn: d.daily.temperature_2m_min[6], h: d.daily.relative_humidity_2m_mean[6], r: d.daily.precipitation_sum.slice(-7).reduce((a, b) => a + b, 0), w: d.daily.wind_speed_10m_max[6], f: d.daily };
            
            $('wIcon').textContent = wIcon(d.daily.weather_code[6]);
            $('wTemp').textContent = Math.round(wData.t);
            $('wHum').textContent = Math.round(wData.h);
            $('wRain').textContent = Math.round(wData.r);
            $('wWind').textContent = Math.round(wData.w);
            
            renderForecast();
            renderMush();
            renderCalcDetail();
            
            $('wLoad').classList.add('hidden');
            $('wContent').classList.remove('hidden');
        } catch (e) { $('wLoad').innerHTML = '<span style="color:var(--danger)">Error</span>'; }
    }
    
    function renderForestBtns() {
        if (!selLoc) return;
        const forests = ['hayedo', 'pinar', 'robledal', 'carrascal', 'pastos'];
        $('forestBtns').innerHTML = forests.map(f => {
            const active = adj.forest === f ? 'active' : '';
            const style = active ? 'background:var(--accent);color:var(--bg)' : '';
            return `<button class="adj-btn ${active}" data-f="${f}" style="${style}">${f.charAt(0).toUpperCase() + f.slice(1)}</button>`;
        }).join('');
        
        $('forestBtns').querySelectorAll('.adj-btn').forEach(b => {
            b.onclick = () => {
                $('forestBtns').querySelectorAll('.adj-btn').forEach(x => { x.classList.remove('active'); x.style.background = ''; x.style.color = ''; });
                b.classList.add('active');
                b.style.background = 'var(--accent)';
                b.style.color = 'var(--bg)';
                adj.forest = b.dataset.f;
                renderMush();
                renderCalcDetail();
            };
        });
    }

    function renderForecast() {
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        const today = new Date().getDay();
        $('f7').innerHTML = [0,1,2,3,4,5,6].map(i => {
            const idx = (today + i) % 7;
            const t = Math.round((wData.f.temperature_2m_max[i] + wData.f.temperature_2m_min[i]) / 2);
            return `<div class="p-1 rounded" style="background:${i === 0 ? 'var(--card)' : 'var(--bg2)'}"><div style="color:var(--muted)">${i === 0 ? 'Hoy' : days[idx]}</div><div>${wIcon(wData.f.weather_code[i])}</div><div class="font-bold">${t}¬∞</div></div>`;
        }).join('');
    }

    function renderMush() {
        if (!selLoc || !wData) return;
        const m = new Date().getMonth() + 1;
        const useForest = adj.forest || selLoc.f[0];
        const rel = MUSH.filter(x => x.fs.includes(useForest));
        const list = rel.map(x => ({...x, p: mushProb(x, wData.t, wData.h, wData.r, m, useForest)})).sort((a, b) => b.p - a.p);
        
        $('mushList').innerHTML = list.map(x => `
            <div class="p-1 rounded cursor-pointer hover:bg-[var(--bg2)]" onclick="openMushroom('${x.id}')">
                <div class="flex justify-between"><span>${x.sc}</span><span style="color:${probCol(x.p)}">${Math.round(x.p)}%</span></div>
                <div class="prob-bar mt-1"><div class="prob-fill" style="width:${x.p}%;background:${probCol(x.p)}"></div></div>
            </div>
        `).join('');
    }
    
    function renderCalcDetail() {
        if (!selLoc || !wData) return;
        const m = new Date().getMonth() + 1;
        const useForest = adj.forest || selLoc.f[0];
        
        const tFactor = wData.t >= 10 && wData.t <= 18 ? 35 : wData.t >= 8 && wData.t <= 22 ? 25 : 10;
        const rFactor = wData.r >= 20 && wData.r <= 60 ? 35 : wData.r >= 10 ? 20 : 10;
        const hFactor = wData.h >= 65 && wData.h <= 85 ? 30 : wData.h >= 55 ? 15 : 10;
        
        const rel = MUSH.filter(x => x.fs.includes(useForest));
        let inSeason = 0, nearSeason = 0;
        for (const x of rel) {
            if (x.ss.includes(m)) inSeason++;
            else if (x.ss.some(s => Math.abs(s - m) === 1)) nearSeason++;
        }
        const seasonPct = rel.length > 0 ? Math.round((inSeason / rel.length) * 100) : 0;
        const nearPct = rel.length > 0 ? Math.round((nearSeason / rel.length) * 100) : 0;
        
        let adjText = [];
        if (adj.forest) adjText.push(`Bosque: ${adj.forest}`);
        if (adj.orient) adjText.push(`Orient: ${adj.orient}`);
        if (adj.zone) adjText.push(`Zona: ${adj.zone}`);
        if (adj.alt !== 0) adjText.push(`Alt: ${adj.alt > 0 ? '+' : ''}${adj.alt}m`);
        
        $('calcTable').innerHTML = `
            <tr><th>Factor</th><th>Valor</th><th>Puntos</th></tr>
            <tr><td>Temperatura</td><td class="value">${Math.round(wData.t)}¬∞C</td><td class="value">${tFactor}</td></tr>
            <tr><td>Lluvia 7 d√≠as</td><td class="value">${Math.round(wData.r)}mm</td><td class="value">${rFactor}</td></tr>
            <tr><td>Humedad</td><td class="value">${Math.round(wData.h)}%</td><td class="value">${hFactor}</td></tr>
            <tr><td>En temporada</td><td class="value">${inSeason}/${rel.length}</td><td class="value">${seasonPct}%</td></tr>
            <tr><td>Cercana</td><td class="value">${nearSeason}/${rel.length}</td><td class="value">${nearPct}%</td></tr>
            ${adjText.length ? `<tr><td colspan="3" style="color:var(--accent)">Ajustes: ${adjText.join(', ')}</td></tr>` : ''}
        `;
    }

    function mushProb(x, t, h, rn, m, forest) {
        let p = 0, sf = 1;
        
        if (x.ss.includes(m)) p += 50;
        else if (x.ss.some(s => Math.abs(s - m) === 1)) { p += 15; sf = 0.6; }
        else sf = 0.2;
        
        if (t >= x.t[0] && t <= x.t[1]) p += 20;
        else if (t >= x.t[0] - 3 && t <= x.t[1] + 3) p += 12;
        
        if (h >= x.h[0] && h <= x.h[1]) p += 15;
        else if (h >= x.h[0] - 10 && h <= x.h[1] + 10) p += 8;
        
        if (rn >= x.r) p += 15;
        else if (rn >= x.r * 0.6) p += 8;
        
        return Math.min(100, Math.max(0, Math.round(p * sf)));
    }

    function wIcon(c) {
        const icons = {0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',51:'üå¶Ô∏è',61:'üåßÔ∏è',71:'üå®Ô∏è',80:'üå¶Ô∏è',95:'‚õàÔ∏è'};
        return icons[c] || 'üå§Ô∏è';
    }

    // ========== GUIDE ==========
    function renderGuide() {
        const q = $('mushSearch').value.toLowerCase();
        const list = MUSH.filter(x => {
            const matchSearch = x.sc.toLowerCase().includes(q) || x.nm.es.toLowerCase().includes(q) || x.nm.eu.toLowerCase().includes(q);
            const matchSeason = activeSeason === 'all' || x.tg.includes(activeSeason);
            const matchHabitat = !activeHabitat || x.fs.includes(activeHabitat);
            return matchSearch && matchSeason && matchHabitat;
        });
        
        $('mushGrid').innerHTML = list.map(x => `
            <div class="card p-2 cursor-pointer hover:border-[var(--accent)]" onclick="openMushroom('${x.id}')">
                <div class="font-semibold text-sm">${x.sc}</div>
                <div class="text-xs" style="color:var(--muted)">${x.nm[lang]}</div>
                <div class="flex items-center justify-between mt-1">
                    <div class="text-xs" style="color:var(--accent2)">${'‚òÖ'.repeat(x.q)}</div>
                    <div class="text-xs" style="color:var(--muted)">${x.ssLab[lang].split(' ')[0]}</div>
                </div>
            </div>
        `).join('');
    }
    
    // Make openMushroom globally available
    window.openMushroom = function(id) {
        const x = MUSH.find(m => m.id === id);
        if (!x) return;
        
        $('mushName').textContent = x.sc;
        $('mushNames').textContent = x.nm[lang];
        
        const svg = mushSVG(x);
        
        // Similar species (edible)
        let similarHtml = '';
        if (x.similar && x.similar.length > 0) {
            similarHtml = `
                <div class="mt-4">
                    <h4 class="font-semibold text-sm mb-2" style="color:var(--accent2)">Especies similares comestibles</h4>
                    <div class="space-y-2">
                        ${x.similar.map(s => `
                            <div class="similarity-box">
                                <div class="font-semibold">${s.sc}</div>
                                <p class="text-xs">${s.nm[lang]}</p>
                                <p class="text-xs mt-1" style="color:var(--fg2)">${s.note[lang]}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Confusable species (toxic)
        let confHtml = '';
        if (x.conf && x.conf.length > 0) {
            confHtml = `
                <div class="mt-4">
                    <h4 class="font-semibold text-sm mb-2" style="color:var(--danger)">ESPECIES PELIGROSAS - ¬°Cuidado!</h4>
                    ${x.conf.map(c => `
                        <div class="danger-box mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold">${c.sc}</span>
                                <span class="text-xs px-2 py-1 rounded" style="background:${c.tx === 'toxic' ? 'var(--danger)' : 'var(--accent)'};color:var(--bg)">${c.tx === 'toxic' ? 'TOXICO' : 'COCINAR'}</span>
                            </div>
                            <p class="text-xs mb-2">${c.nm[lang]}</p>
                            <p class="text-xs font-semibold mb-1" style="color:var(--fg)">Diferencias clave:</p>
                            <ul class="text-xs space-y-1" style="color:var(--fg2)">
                                ${c.diff[lang].map(d => `<li>‚Ä¢ ${d}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        $('mushContent').innerHTML = `
            <div class="grid sm:grid-cols-2 gap-3 mb-3">
                <div class="mush-img">${svg}</div>
                <div>
                    <p class="text-sm mb-2" style="color:var(--fg2)">${x.ds[lang]}</p>
                    <p class="text-xs mb-1"><span style="color:var(--muted)">Calidad:</span> <span style="color:var(--accent)">${'‚òÖ'.repeat(x.q)}</span></p>
                    <p class="text-xs"><span style="color:var(--muted)">Esporada:</span> ${x.sp[lang]}</p>
                </div>
            </div>
            
            <div class="mb-3">
                <h4 class="font-semibold text-sm mb-2" style="color:var(--accent)">Caracter√≠sticas de identificaci√≥n:</h4>
                <ul class="feature-list text-xs">
                    ${x.features[lang].map(f => `<li>${f}</li>`).join('')}
                </ul>
            </div>
            
            <div class="detail-grid text-xs mb-3">
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">Sombrero</div><div class="font-semibold">${x.sz.c[0]}-${x.sz.c[1]} cm</div></div>
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">Pie</div><div class="font-semibold">${x.sz.h[0]}-${x.sz.h[1]} cm</div></div>
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">Temporada</div><div class="font-semibold">${x.ssLab[lang]}</div></div>
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">H√°bitat</div><div class="font-semibold">${x.fsLab[lang]}</div></div>
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">Temp. √≥ptima</div><div class="font-semibold">${x.t[0]}-${x.t[1]}¬∞C</div></div>
                <div class="p-2 rounded" style="background:var(--bg2)"><div style="color:var(--muted)">Humedad √≥ptima</div><div class="font-semibold">${x.h[0]}-${x.h[1]}%</div></div>
            </div>
            
            <div class="flex flex-wrap gap-1">
                ${x.tg.map(t => `<span class="tag" style="background:var(--bg2)">${t}</span>`).join('')}
            </div>
            
            ${similarHtml}
            ${confHtml}
        `;
        
        $('mushModal').classList.remove('hidden');
    };

    // ========== MUSHROOM SVG ==========
    function mushSVG(x) {
        // Detailed SVG based on species
        if (x.id === 'b_edu') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <defs>
                    <linearGradient id="capG" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#A0782C"/>
                        <stop offset="100%" style="stop-color:#6B5A1E"/>
                    </linearGradient>
                    <radialGradient id="poreG" cx="50%" cy="50%">
                        <stop offset="0%" style="stop-color:#F5E6C8"/>
                        <stop offset="100%" style="stop-color:#D4C9B0"/>
                    </radialGradient>
                </defs>
                <!-- Shadow -->
                <ellipse cx="100" cy="140" rx="50" ry="8" fill="rgba(0,0,0,0.2)"/>
                <!-- Cap -->
                <ellipse cx="100" cy="50" rx="70" ry="35" fill="url(#capG)"/>
                <ellipse cx="100" cy="50" rx="55" ry="25" fill="#8B6914" opacity="0.5"/>
                <!-- Pores -->
                <ellipse cx="100" cy="70" rx="50" ry="20" fill="url(#poreG)"/>
                ${Array.from({length:9}, (_, i) => `<ellipse cx="${60+i*10}" cy="${68+Math.sin(i)*5}" rx="3" ry="6" fill="#C9B896"/>`).join('')}
                <!-- Stem -->
                <path d="M75 75 L75 125 Q75 135 85 135 L115 135 Q125 135 125 125 L125 75" fill="#F5F0DC"/>
                <path d="M80 85 L80 120" stroke="#D4C9B0" stroke-width="1"/>
                <!-- Reticulum -->
                <path d="M85 90 L90 100 L85 110 L90 120" stroke="#D4C9B0" stroke-width="0.8" fill="none"/>
                <path d="M100 88 L105 98 L100 108 L105 118" stroke="#D4C9B0" stroke-width="0.8" fill="none"/>
                <path d="M115 90 L120 100 L115 110 L120 120" stroke="#D4C9B0" stroke-width="0.8" fill="none"/>
            </svg>`;
        }
        
        if (x.id === 'l_del') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="45" ry="7" fill="rgba(0,0,0,0.2)"/>
                <!-- Depressed cap -->
                <ellipse cx="100" cy="55" rx="65" ry="32" fill="#E67322"/>
                <ellipse cx="100" cy="55" rx="50" ry="25" fill="#F28C28"/>
                <ellipse cx="100" cy="55" rx="32" ry="16" fill="#E67322"/>
                <ellipse cx="100" cy="58" rx="15" ry="8" fill="#D4681F"/>
                <!-- Gills -->
                <path d="M45 60 L45 75" stroke="#E8B060" stroke-width="1"/>
                <path d="M60 58 L60 80" stroke="#E8B060" stroke-width="1"/>
                <path d="M75 56 L75 82" stroke="#E8B060" stroke-width="1"/>
                <path d="M90 55 L90 85" stroke="#E8B060" stroke-width="1"/>
                <path d="M105 55 L105 85" stroke="#E8B060" stroke-width="1"/>
                <path d="M120 56 L120 82" stroke="#E8B060" stroke-width="1"/>
                <path d="M135 58 L135 80" stroke="#E8B060" stroke-width="1"/>
                <path d="M150 60 L150 75" stroke="#E8B060" stroke-width="1"/>
                <!-- Stem -->
                <path d="M80 75 L80 120 Q80 128 88 128 L112 128 Q120 128 120 120 L120 75" fill="#F28C28"/>
            </svg>`;
        }
        
        if (x.id === 'c_cib') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="40" ry="6" fill="rgba(0,0,0,0.2)"/>
                <!-- Funnel cap -->
                <ellipse cx="100" cy="50" rx="60" ry="30" fill="#E8B830"/>
                <ellipse cx="100" cy="55" rx="25" ry="12" fill="#1a1f16"/>
                <!-- False gills -->
                <path d="M50 55 Q55 70 60 80" stroke="#D4A017" stroke-width="2" fill="none"/>
                <path d="M65 52 Q72 72 80 85" stroke="#D4A017" stroke-width="2" fill="none"/>
                <path d="M85 50 Q95 75 105 88" stroke="#D4A017" stroke-width="2" fill="none"/>
                <path d="M110 52 Q118 72 125 85" stroke="#D4A017" stroke-width="2" fill="none"/>
                <path d="M130 55 Q137 70 142 80" stroke="#D4A017" stroke-width="2" fill="none"/>
                <!-- Stem -->
                <path d="M85 70 L85 125 L115 125 L115 70" fill="#E8B830"/>
            </svg>`;
        }
        
        if (x.id === 'a_rub') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="45" ry="7" fill="rgba(0,0,0,0.2)"/>
                <ellipse cx="100" cy="50" rx="65" ry="35" fill="#8B4513"/>
                <!-- White scales -->
                <circle cx="70" cy="40" r="5" fill="#F5F5F5" opacity="0.8"/>
                <circle cx="100" cy="35" r="4" fill="#F5F5F5" opacity="0.7"/>
                <circle cx="130" cy="42" r="5" fill="#F5F5F5" opacity="0.8"/>
                <circle cx="85" cy="55" r="3" fill="#F5F5F5" opacity="0.6"/>
                <circle cx="115" cy="52" r="3" fill="#F5F5F5" opacity="0.6"/>
                <!-- Ring -->
                <ellipse cx="100" cy="85" rx="20" ry="3" fill="#F5F0DC" stroke="#D4C9B0"/>
                <line x1="85" y1="85" x2="85" y2="88" stroke="#D4C9B0"/>
                <line x1="90" y1="85" x2="90" y2="89" stroke="#D4C9B0"/>
                <line x1="95" y1="85" x2="95" y2="90" stroke="#D4C9B0"/>
                <line x1="100" y1="85" x2="100" y2="90" stroke="#D4C9B0"/>
                <line x1="105" y1="85" x2="105" y2="89" stroke="#D4C9B0"/>
                <line x1="110" y1="85" x2="110" y2="88" stroke="#D4C9B0"/>
                <!-- Stem -->
                <path d="M80 75 L80 130 Q80 138 88 138 L112 138 Q120 138 120 130 L120 75" fill="#F5F0DC"/>
            </svg>`;
        }
        
        if (x.id === 'h_rep') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="45" ry="7" fill="rgba(0,0,0,0.2)"/>
                <!-- Irregular cap -->
                <ellipse cx="100" cy="45" rx="60" ry="30" fill="#D4B896"/>
                <ellipse cx="100" cy="48" rx="45" ry="22" fill="#C4A878"/>
                <!-- Spines -->
                <line x1="55" y1="60" x2="50" y2="85" stroke="#B89860" stroke-width="2"/>
                <line x1="70" y1="65" x2="65" y2="95" stroke="#B89860" stroke-width="2"/>
                <line x1="85" y1="68" x2="82" y2="100" stroke="#B89860" stroke-width="2"/>
                <line x1="100" y1="70" x2="100" y2="105" stroke="#B89860" stroke-width="2"/>
                <line x1="115" y1="68" x2="118" y2="100" stroke="#B89860" stroke-width="2"/>
                <line x1="130" y1="65" x2="135" y2="95" stroke="#B89860" stroke-width="2"/>
                <line x1="145" y1="60" x2="150" y2="85" stroke="#B89860" stroke-width="2"/>
                <!-- Stem -->
                <path d="M78 70 L78 125 L122 125 L122 70" fill="#D4B896"/>
            </svg>`;
        }
        
        if (x.id === 'c_cor') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="35" ry="5" fill="rgba(0,0,0,0.2)"/>
                <!-- Trumpet shape -->
                <path d="M60 40 Q100 60 140 40 L120 130 Q100 135 80 130 Z" fill="#3A3A3A"/>
                <path d="M70 45 Q100 60 130 45 L115 125 Q100 128 85 125 Z" fill="#2A2A2A"/>
            </svg>`;
        }
        
        if (x.id === 'l_nud') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="45" ry="7" fill="rgba(0,0,0,0.2)"/>
                <ellipse cx="100" cy="50" rx="60" ry="32" fill="#9B6B9B"/>
                <ellipse cx="100" cy="52" rx="45" ry="24" fill="#B88AB8"/>
                <!-- Crowded gills -->
                ${Array.from({length:15}, (_, i) => `<line x1="${50+i*7}" y1="60" x2="${50+i*7}" y2="90" stroke="#8B6B8B" stroke-width="1"/>`).join('')}
                <path d="M80 70 L80 125 L120 125 L120 70" fill="#C9A0C9"/>
            </svg>`;
        }
        
        if (x.id === 'm_pro') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="140" rx="20" ry="4" fill="rgba(0,0,0,0.2)"/>
                <!-- Large cap with scales -->
                <ellipse cx="100" cy="35" rx="75" ry="25" fill="#D2B48C"/>
                <ellipse cx="100" cy="35" rx="60" ry="18" fill="#C4A070"/>
                <circle cx="70" cy="30" r="5" fill="#8B4513"/>
                <circle cx="90" cy="25" r="4" fill="#8B4513"/>
                <circle cx="110" cy="28" r="5" fill="#8B4513"/>
                <circle cx="130" cy="32" r="4" fill="#8B4513"/>
                <!-- Dark center -->
                <ellipse cx="100" cy="35" rx="8" ry="5" fill="#6B4423"/>
                <!-- Very tall stem -->
                <path d="M92 50 L92 138 L108 138 L108 50" fill="#F5F0DC"/>
                <!-- Double movable ring -->
                <ellipse cx="100" cy="70" rx="15" ry="2" fill="#F5F0DC" stroke="#D4C9B0"/>
                <ellipse cx="100" cy="75" rx="15" ry="2" fill="#F5F0DC" stroke="#D4C9B0"/>
            </svg>`;
        }
        
        if (x.id === 't_mel') {
            return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
                <ellipse cx="100" cy="100" rx="50" ry="40" fill="#1A1A1A"/>
                <ellipse cx="100" cy="95" rx="45" ry="35" fill="#2A2A2A"/>
                <!-- Pyramidal warts -->
                <polygon points="60,75 65,90 55,90" fill="#1A1A1A"/>
                <polygon points="80,70 85,88 75,88" fill="#1A1A1A"/>
                <polygon points="100,68 105,85 95,85" fill="#1A1A1A"/>
                <polygon points="120,72 125,88 115,88" fill="#1A1A1A"/>
                <polygon points="140,78 145,92 135,92" fill="#1A1A1A"/>
                <!-- White veins inside -->
                <path d="M70 100 Q85 90 100 105 Q115 90 130 100" stroke="#FFF" stroke-width="2" fill="none" opacity="0.5"/>
                <path d="M80 110 Q100 100 120 110" stroke="#FFF" stroke-width="2" fill="none" opacity="0.4"/>
            </svg>`;
        }
        
        // Default
        return `<svg viewBox="0 0 200 160" style="width:160px;height:130px">
            <ellipse cx="100" cy="140" rx="45" ry="7" fill="rgba(0,0,0,0.2)"/>
            <ellipse cx="100" cy="50" rx="55" ry="28" fill="#8B6914"/>
            <path d="M80 65 L80 125 L120 125 L120 65" fill="#F5F0DC"/>
        </svg>`;
    }

    // ========== CAPTURES ==========
    function saveCapture() {
        if (!selLoc || !wData) return;
        const capture = {
            id: Date.now(),
            date: new Date().toISOString(),
            loc: selLoc.name,
            lat: selLoc.lat,
            lon: selLoc.lon,
            forest: adj.forest || selLoc.f[0],
            orient: adj.orient,
            zone: adj.zone,
            alt: adj.alt,
            weather: { t: wData.t, h: wData.h, r: wData.r }
        };
        captures.unshift(capture);
        localStorage.setItem('mico_captures', JSON.stringify(captures));
        renderCaptures();
        alert('Captura guardada');
    }
    
    function renderCaptures() {
        if (!captures.length) {
            $('captureList').innerHTML = '<p style="color:var(--muted)">Sin capturas</p>';
            return;
        }
        $('captureList').innerHTML = captures.map(c => {
            const d = new Date(c.date);
            return `<div class="p-2 rounded" style="background:var(--bg2)">
                <div class="flex justify-between"><span class="font-semibold">${c.loc}</span><span class="cursor-pointer" style="color:var(--muted)" onclick="delCapture(${c.id})">‚úï</span></div>
                <div class="text-xs" style="color:var(--muted)">${d.toLocaleDateString()} | T:${Math.round(c.weather.t)}¬∞</div>
            </div>`;
        }).join('');
    }
    
    function delCapture(id) {
        captures = captures.filter(x => x.id !== id);
        localStorage.setItem('mico_captures', JSON.stringify(captures));
        renderCaptures();
    }

    // ========== NOTES ==========
    function populateMushSelect() {
        $('noteMush').innerHTML = '<option value="">Seta</option>' + MUSH.map(x => `<option value="${x.id}">${x.sc}</option>`).join('');
    }

    function addNote() {
        const m = $('noteMush').value, l = $('noteLoc').value, q = $('noteQty').value, d = $('noteDate').value, t = $('noteText').value;
        if (!m || !l || !d) { alert('Completa'); return; }
        const mu = MUSH.find(x => x.id === m);
        notes.unshift({ id: Date.now(), mid: m, mn: mu.nm[lang], sc: mu.sc, loc: l, qty: q||'N/A', dt: d, txt: t });
        localStorage.setItem('mico_notes', JSON.stringify(notes));
        $('noteMush').value = $('noteLoc').value = $('noteQty').value = $('noteText').value = '';
        renderNotes();
    }

    function renderNotes() {
        if (!notes.length) { $('notesList').innerHTML = '<span style="color:var(--muted)">Sin entradas</span>'; return; }
        $('notesList').innerHTML = notes.map(n => `<div class="p-2 rounded mb-2" style="background:var(--bg2)"><div class="flex justify-between"><span class="font-semibold">${n.mn}</span><span class="cursor-pointer" style="color:var(--muted)" onclick="delNote(${n.id})">‚úï</span></div><div class="text-xs" style="color:var(--muted)">${n.loc} | ${n.dt}</div></div>`).join('');
    }

    function delNote(id) {
        notes = notes.filter(x => x.id !== id);
        localStorage.setItem('mico_notes', JSON.stringify(notes));
        renderNotes();
    }
    </script>
</body>
</html>